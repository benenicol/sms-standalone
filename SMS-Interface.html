<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Notification Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .template-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .message-box {
            width: 200px;
            height: 60px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .checkbox-column {
            width: 50px;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .bulk-actions {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .char-counter {
            font-size: 12px;
            text-align: right;
            margin-top: 5px;
            font-weight: bold;
        }
        .char-counter.safe {
            color: #28a745;
        }
        .char-counter.warning {
            color: #ffc107;
        }
        .char-counter.danger {
            color: #dc3545;
        }
        .form-group {
            position: relative;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 0;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            background-color: #e9ecef;
            color: #495057;
        }
        .tab-button.active {
            color: #007cba;
            border-bottom-color: #007cba;
            background-color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Inbox Styles */
        .inbox-container {
            display: flex;
            height: 70vh;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        .customer-list {
            width: 350px;
            border-right: 1px solid #e9ecef;
            background-color: #f8f9fa;
            overflow-y: auto;
        }
        .conversation-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        .customer-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .customer-item:hover {
            background-color: #e9ecef;
        }
        .customer-item.active {
            background-color: #007cba;
            color: white;
        }
        .customer-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .customer-phone {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .customer-item.active .customer-phone {
            color: #cce7f0;
        }
        .last-message {
            font-size: 14px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .customer-item.active .last-message {
            color: #e6f3ff;
        }
        .message-timestamp {
            font-size: 11px;
            color: #6c757d;
            float: right;
        }
        .customer-item.active .message-timestamp {
            color: #cce7f0;
        }
        
        /* Conversation Messages */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .message-bubble {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message-inbound {
            background-color: #e9ecef;
            color: #495057;
            margin-right: auto;
        }
        .message-outbound {
            background-color: #007cba;
            color: white;
            margin-left: auto;
        }
        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Quick Reply */
        .quick-reply {
            border-top: 1px solid #e9ecef;
            padding: 15px;
            background-color: white;
        }
        .reply-input {
            display: flex;
            gap: 10px;
        }
        .reply-textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            max-height: 100px;
        }
        .reply-send-btn {
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
        }
        .empty-state h3 {
            margin-bottom: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .tab-button {
                padding: 12px 15px;
                font-size: 14px;
            }
            .inbox-container {
                flex-direction: column;
                height: auto;
            }
            .customer-list {
                width: 100%;
                max-height: 300px;
            }
            .conversation-view {
                min-height: 400px;
            }
            .message-bubble {
                max-width: 85%;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                padding: 10px 12px;
                font-size: 13px;
            }
            .customer-item {
                padding: 12px;
            }
            .messages-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <h1>SMS Notification Manager - Standalone</h1>
    
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('sms-sending')">SMS Sending</button>
        <button class="tab-button" onclick="switchTab('inbox')">Inbox</button>
    </div>
    
    <div id="sms-sending" class="tab-content active">
        <div class="container">
        <h2>SMS Templates</h2>
        <div class="template-section">
            <h3>Home Delivery Templates</h3>
            <div class="form-group">
                <label for="home-delivery-default">Default Home Delivery:</label>
                <textarea id="home-delivery-default" oninput="updateCharCount('home-delivery-default')">Hi {firstName}, thanks for your {subscriptionItems} order! We'll be in touch with delivery details.</textarea>
                <div class="char-counter" id="home-delivery-default-counter">0 chars</div>
            </div>
        </div>
        
        <div class="template-section">
            <h3>Pickup Templates</h3>
            <div class="form-group">
                <label for="pickup-default">Default Pickup:</label>
                <textarea id="pickup-default" oninput="updateCharCount('pickup-default')">Hi {firstName}, your {subscriptionItems} order will be ready tomorrow. We'll send you pickup details shortly.</textarea>
                <div class="char-counter" id="pickup-default-counter">0 chars</div>
            </div>
            <div class="form-group">
                <label for="pickup-ready">Ready for Pickup:</label>
                <textarea id="pickup-ready" oninput="updateCharCount('pickup-ready')">Hi {firstName}, your {subscriptionItems} order is ready for pickup at our location. Please bring your order confirmation.</textarea>
                <div class="char-counter" id="pickup-ready-counter">0 chars</div>
            </div>
        </div>
        
        <div class="template-section">
            <h3>Tag-Specific Templates</h3>
            <div class="form-group">
                <label for="tag-templates">Tag Templates (one per line: tagname=message):</label>
                <textarea id="tag-templates" style="height: 140px;" oninput="updateCharCount('tag-templates')">urgent=Hi {firstName}, your urgent {subscriptionItems} order is being prioritized and will be processed today!
ready=Hi {firstName}, your {subscriptionItems} order is ready! 
delivery_today=Hi {firstName}, your {subscriptionItems} order will be delivered today between 10am-4pm.
appstle_subscription_first_order=Hi {firstName}, welcome to BeefBoxAI3000! Your first {subscriptionItems} subscription order is being prepared. We're excited to have you on board!</textarea>
                <div class="char-counter" id="tag-templates-counter">0 chars</div>
            </div>
        </div>
        
        <button onclick="loadOrders()">Load Unfulfilled Orders</button>
        <button onclick="updateMessagePreviews()">Update Message Previews</button>
    </div>

    <div class="container">
        <h2>Test Message</h2>
        <div class="form-group">
            <label for="test-template-selector">Select Template or Custom:</label>
            <select id="test-template-selector" onchange="updateTestMessage()">
                <option value="custom">Custom Message</option>
                <option value="home-delivery-default">Home Delivery - Default</option>
                <option value="pickup-default">Pickup - Default</option>
                <option value="pickup-ready">Pickup - Ready</option>
                <option value="tag-urgent">Tag - Urgent</option>
                <option value="tag-ready">Tag - Ready</option>
                <option value="tag-delivery_today">Tag - Delivery Today</option>
                <option value="tag-appstle_subscription_first_order">Tag - First Order Welcome</option>
            </select>
        </div>
        <div class="form-group">
            <label for="test-message">Test Message:</label>
            <textarea id="test-message" placeholder="Enter test message here..." oninput="updateCharCount('test-message')">Hi there, this is a test message from BeefBoxAI3000 SMS system!</textarea>
            <div class="char-counter" id="test-message-counter">0 chars</div>
        </div>
        <div class="form-group">
            <label>Test personalization with:</label>
            <input type="text" id="test-first-name" placeholder="First Name" value="John" style="width: 30%; margin-right: 10px;">
            <input type="text" id="test-subscription-items" placeholder="Subscription Items" value="Quarter of a Quarter Ã—1 (A)" style="width: 65%;">
        </div>
        <button onclick="sendTestMessage()">Send Test Message to +61459988890</button>
        <div id="test-status"></div>
    </div>

    <div class="container">
        <div class="bulk-actions">
            <button onclick="selectAll()">Select All</button>
            <button onclick="selectNone()">Select None</button>
            <button onclick="sendBulkSMS()" id="bulk-send-btn" disabled>Send Selected SMS Messages</button>
            <span id="selected-count">0 selected</span>
        </div>
        
        <div id="status"></div>
        <div id="orders-container">
            <div class="loading">Click "Load Unfulfilled Orders" to get started</div>
        </div>
    </div>
    </div> <!-- Close SMS Sending Tab -->

    <div id="inbox" class="tab-content">
        <div class="container">
            <div class="inbox-container">
                <div class="customer-list">
                    <div id="customer-list-content">
                        <div class="empty-state">
                            <h3>No Conversations</h3>
                            <p>Customer messages will appear here</p>
                            <button onclick="loadInboxConversations()">Load Conversations</button>
                        </div>
                    </div>
                </div>
                
                <div class="conversation-view">
                    <div id="conversation-content">
                        <div class="empty-state">
                            <h3>Select a Conversation</h3>
                            <p>Choose a customer from the list to view their messages</p>
                        </div>
                    </div>
                    
                    <div class="quick-reply" id="quick-reply" style="display: none;">
                        <div class="reply-input">
                            <textarea class="reply-textarea" id="reply-message" placeholder="Type your reply..." oninput="updateCharCount('reply-message')"></textarea>
                            <button class="reply-send-btn" onclick="sendQuickReply()">ðŸ“¤</button>
                        </div>
                        <div class="char-counter" id="reply-message-counter">0 chars</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let orders = [];
        let conversations = [];
        let selectedCustomerId = null;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return null;
            
            // Remove all non-digit characters
            let cleaned = phone.replace(/\D/g, '');
            
            // If it starts with 0, assume it's Australian and replace with +61
            if (cleaned.startsWith('0')) {
                cleaned = '61' + cleaned.substring(1);
            }
            
            // If it doesn't start with country code, assume Australian
            if (!cleaned.startsWith('61') && !cleaned.startsWith('1')) {
                cleaned = '61' + cleaned;
            }
            
            return '+' + cleaned;
        }

        function determineDeliveryMethod(order) {
            // Check shipping method title
            if (order.shipping_lines && order.shipping_lines.length > 0) {
                const shippingTitle = order.shipping_lines[0].title.toLowerCase();
                if (shippingTitle.includes('pickup') || shippingTitle.includes('collection')) {
                    return 'Pickup';
                }
                if (shippingTitle.includes('delivery') || shippingTitle.includes('shipping')) {
                    return 'Home Delivery';
                }
            }
            
            // Check if there's a shipping address
            if (order.shipping_address) {
                return 'Home Delivery';
            }
            
            // Default fallback
            return 'Pickup';
        }

        function parseTagTemplates() {
            const tagTemplatesText = document.getElementById('tag-templates').value;
            const templates = {};
            
            tagTemplatesText.split('\n').forEach(line => {
                const trimmed = line.trim();
                if (trimmed && trimmed.includes('=')) {
                    const [tag, message] = trimmed.split('=', 2);
                    templates[tag.trim().toLowerCase()] = message.trim();
                }
            });
            
            return templates;
        }

        function getMessageTemplate(deliveryMethod, tags, order) {
            const tagTemplates = parseTagTemplates();
            
            // Check for tag-specific templates first
            for (const tag of tags) {
                const lowerTag = tag.toLowerCase();
                if (tagTemplates[lowerTag]) {
                    return tagTemplates[lowerTag];
                }
            }
            
            // Fall back to delivery method templates
            const isPickup = deliveryMethod === 'Pickup';
            const hasReadyTag = tags.some(tag => tag.toLowerCase().includes('ready') || tag.toLowerCase().includes('completed'));
            
            if (isPickup) {
                if (hasReadyTag) {
                    return document.getElementById('pickup-ready').value;
                }
                return document.getElementById('pickup-default').value;
            } else {
                return document.getElementById('home-delivery-default').value;
            }
        }

        function personalizeMessage(template, order, subscriptionItems) {
            const firstName = order.customer?.first_name || 'there';
            
            return template
                .replace(/{firstName}/g, firstName)
                .replace(/{subscriptionItems}/g, subscriptionItems || 'order');
        }

        function loadOrders() {
            showStatus('Loading unfulfilled orders...', 'info');
            
            google.script.run
                .withSuccessHandler(function(ordersData) {
                    orders = ordersData;
                    showStatus(`Loaded ${orders.length} unfulfilled orders`, 'success');
                    displayOrders();
                })
                .withFailureHandler(function(error) {
                    showStatus(`Error loading orders: ${error.message}`, 'error');
                    console.error('Error:', error);
                })
                .getUnfulfilledOrders();
        }

        function displayOrders() {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="loading">No unfulfilled orders found</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-column">Send</th>
                            <th>Order #</th>
                            <th>Customer Name</th>
                            <th>Phone</th>
                            <th>Delivery Type</th>
                            <th>Order Tags</th>
                            <th>Message Preview</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach((order, index) => {
                const customerName = order.customer ? 
                    `${order.customer.first_name || ''} ${order.customer.last_name || ''}`.trim() : 
                    'Unknown Customer';
                
                const phone = order.customer?.phone || order.billing_address?.phone || order.shipping_address?.phone || '';
                const formattedPhone = formatPhoneNumber(phone);
                const deliveryMethod = determineDeliveryMethod(order);
                const tags = order.tags ? order.tags.split(',').map(tag => tag.trim()) : [];
                
                // Get subscription items like Orders & Picklist Export
                const subscriptionItems = order.subscriptionItems || '';
                
                const messageTemplate = getMessageTemplate(deliveryMethod, tags, order);
                const personalizedMessage = personalizeMessage(messageTemplate, order, subscriptionItems);
                
                html += `
                    <tr>
                        <td class="checkbox-column">
                            <input type="checkbox" id="order-${index}" onchange="updateSelectedCount()" 
                                   ${formattedPhone ? '' : 'disabled'}>
                        </td>
                        <td>#${order.order_number || order.name}</td>
                        <td>${customerName}</td>
                        <td>${formattedPhone || '<span style="color: red;">No phone</span>'}</td>
                        <td>${deliveryMethod}</td>
                        <td>${tags.join(', ') || 'None'}</td>
                        <td>
                            <textarea class="message-box" id="message-${index}" oninput="updateCharCount('message-${index}')">${personalizedMessage}</textarea>
                            <div class="char-counter" id="message-${index}-counter" style="font-size: 10px;">0 chars</div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            updateSelectedCount();
            
            // Update character counts for all order messages
            orders.forEach((order, index) => {
                updateCharCount(`message-${index}`);
            });
        }

        function updateMessagePreviews() {
            orders.forEach((order, index) => {
                const deliveryMethod = determineDeliveryMethod(order);
                const tags = order.tags ? order.tags.split(',').map(tag => tag.trim()) : [];
                const subscriptionItems = order.subscriptionItems || '';
                
                const messageTemplate = getMessageTemplate(deliveryMethod, tags, order);
                const personalizedMessage = personalizeMessage(messageTemplate, order, subscriptionItems);
                
                const messageBox = document.getElementById(`message-${index}`);
                if (messageBox) {
                    messageBox.value = personalizedMessage;
                    updateCharCount(`message-${index}`);
                }
            });
            showStatus('Message previews updated', 'success');
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="order-"]');
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = true;
            });
            updateSelectedCount();
        }

        function selectNone() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="order-"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="order-"]:checked');
            const count = checkboxes.length;
            document.getElementById('selected-count').textContent = `${count} selected`;
            document.getElementById('bulk-send-btn').disabled = count === 0;
        }

        function sendBulkSMS() {
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="order-"]:checked');
            if (selectedCheckboxes.length === 0) {
                showStatus('No orders selected', 'error');
                return;
            }

            showStatus(`Preparing to send ${selectedCheckboxes.length} SMS messages...`, 'info');
            
            const smsData = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.id.split('-')[1]);
                const order = orders[index];
                const message = document.getElementById(`message-${index}`).value;
                
                const phone = order.customer?.phone || order.billing_address?.phone || order.shipping_address?.phone || '';
                const formattedPhone = formatPhoneNumber(phone);
                
                if (formattedPhone && message.trim()) {
                    smsData.push({
                        phone: formattedPhone,
                        message: message.trim(),
                        customerName: order.customer ? 
                            `${order.customer.first_name || ''} ${order.customer.last_name || ''}`.trim() : 
                            'Unknown Customer',
                        orderNumber: order.order_number || order.name
                    });
                }
            });

            if (smsData.length === 0) {
                showStatus('No valid SMS data to send', 'error');
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.errors && result.errors.length > 0) {
                        showStatus(`Sent ${result.successCount} SMS messages, ${result.errors.length} failed`, 'error');
                    } else {
                        showStatus(`Successfully sent ${result.successCount} SMS messages!`, 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus(`Error sending SMS messages: ${error.message}`, 'error');
                })
                .sendBulkSMSMessages(smsData);
        }

        function updateTestMessage() {
            const selector = document.getElementById('test-template-selector').value;
            const messageTextarea = document.getElementById('test-message');
            
            if (selector === 'custom') {
                return; // Keep current custom message
            }
            
            let template = '';
            
            if (selector === 'home-delivery-default') {
                template = document.getElementById('home-delivery-default').value;
            } else if (selector === 'pickup-default') {
                template = document.getElementById('pickup-default').value;
            } else if (selector === 'pickup-ready') {
                template = document.getElementById('pickup-ready').value;
            } else if (selector.startsWith('tag-')) {
                const tagName = selector.replace('tag-', '');
                const tagTemplates = parseTagTemplates();
                template = tagTemplates[tagName] || '';
            }
            
            if (template) {
                // Apply test personalization
                const firstName = document.getElementById('test-first-name').value || 'there';
                const subscriptionItems = document.getElementById('test-subscription-items').value || 'order';
                
                const personalizedTemplate = template
                    .replace(/{firstName}/g, firstName)
                    .replace(/{subscriptionItems}/g, subscriptionItems);
                
                messageTextarea.value = personalizedTemplate;
                updateCharCount('test-message');
            }
        }

        function sendTestMessage() {
            const message = document.getElementById('test-message').value.trim();
            
            if (!message) {
                showTestStatus('Please enter a test message', 'error');
                return;
            }

            showTestStatus('Sending test message...', 'info');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showTestStatus('Test message sent successfully!', 'success');
                    } else {
                        showTestStatus(`Test message failed: ${result.error}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showTestStatus(`Error sending test message: ${error.message}`, 'error');
                })
                .sendTestSMS(message);
        }

        function showTestStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function updateCharCount(textareaId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(textareaId + '-counter');
            
            if (!textarea || !counter) return;
            
            const text = textarea.value;
            const length = text.length;
            
            // Calculate SMS segments
            let segments = 1;
            let maxChars = 160;
            
            // Check if text contains non-GSM characters (emojis, unicode)
            const hasUnicode = /[^\x00-\x7F]/.test(text);
            if (hasUnicode) {
                maxChars = 70;
            }
            
            if (length > maxChars) {
                segments = Math.ceil(length / (maxChars - 7)); // -7 for concatenation header
            }
            
            // Update counter text
            let counterText = `${length} chars`;
            if (segments > 1) {
                counterText += ` (${segments} SMS)`;
            }
            
            counter.textContent = counterText;
            
            // Update color based on length
            counter.className = 'char-counter';
            if (length <= 140) {
                counter.classList.add('safe');
            } else if (length <= 160) {
                counter.classList.add('warning');
            } else {
                counter.classList.add('danger');
            }
        }

        function updateAllCharCounts() {
            updateCharCount('home-delivery-default');
            updateCharCount('pickup-default');
            updateCharCount('pickup-ready');
            updateCharCount('tag-templates');
            updateCharCount('test-message');
        }

        // Initialize character counts when page loads
        window.addEventListener('load', function() {
            updateAllCharCounts();
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load inbox data if switching to inbox
            if (tabName === 'inbox' && conversations.length === 0) {
                loadInboxConversations();
            }
        }

        // Load inbox conversations
        function loadInboxConversations() {
            showStatus('Loading conversations...', 'info');
            
            google.script.run
                .withSuccessHandler(function(customerConversations) {
                    conversations = customerConversations;
                    displayCustomerList();
                    showStatus(`Loaded ${conversations.length} conversations`, 'success');
                })
                .withFailureHandler(function(error) {
                    showStatus(`Error loading conversations: ${error.message}`, 'error');
                    console.error('Error:', error);
                })
                .getCustomerConversations();
        }

        // Display customer list in inbox
        function displayCustomerList() {
            const container = document.getElementById('customer-list-content');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Conversations</h3>
                        <p>Customer messages will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            conversations.forEach((customer, index) => {
                const latestMessage = customer.latestMessage;
                const messagePreview = latestMessage ? 
                    (latestMessage.content.length > 50 ? 
                        latestMessage.content.substring(0, 50) + '...' : 
                        latestMessage.content) : 
                    'No messages';
                
                const timestamp = latestMessage ? 
                    formatTimestamp(new Date(latestMessage.timestamp)) : '';
                
                html += `
                    <div class="customer-item" onclick="selectCustomer('${customer.customerId}', ${index})">
                        <div class="message-timestamp">${timestamp}</div>
                        <div class="customer-name">${customer.profile.name}</div>
                        <div class="customer-phone">${customer.profile.phone || 'No phone'}</div>
                        <div class="last-message">${messagePreview}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Select customer and show conversation
        function selectCustomer(customerId, index) {
            selectedCustomerId = customerId;
            
            // Update selected state in customer list
            const customerItems = document.querySelectorAll('.customer-item');
            customerItems.forEach(item => item.classList.remove('active'));
            customerItems[index].classList.add('active');
            
            // Display conversation
            displayConversation(conversations[index]);
            
            // Show quick reply
            document.getElementById('quick-reply').style.display = 'block';
        }

        // Display conversation messages
        function displayConversation(customerData) {
            const container = document.getElementById('conversation-content');
            const messages = customerData.conversations || [];
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Messages</h3>
                        <p>Start a conversation with ${customerData.profile.name}</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="messages-container">';
            messages.forEach(message => {
                const isInbound = message.direction === 'inbound';
                const bubbleClass = isInbound ? 'message-inbound' : 'message-outbound';
                const timestamp = formatTimestamp(new Date(message.timestamp));
                
                html += `
                    <div class="message-bubble ${bubbleClass}">
                        <div>${message.content}</div>
                        <div class="message-meta">${timestamp}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
            
            // Scroll to bottom
            const messagesContainer = container.querySelector('.messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Send quick reply
        function sendQuickReply() {
            const message = document.getElementById('reply-message').value.trim();
            
            if (!message) {
                showStatus('Please enter a message', 'error');
                return;
            }
            
            if (!selectedCustomerId) {
                showStatus('Please select a customer', 'error');
                return;
            }
            
            showStatus('Sending reply...', 'info');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showStatus('Reply sent successfully!', 'success');
                        document.getElementById('reply-message').value = '';
                        updateCharCount('reply-message');
                        
                        // Refresh conversation
                        loadInboxConversations();
                    } else {
                        showStatus(`Reply failed: ${result.error}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showStatus(`Error sending reply: ${error.message}`, 'error');
                })
                .sendCustomerReply(selectedCustomerId, message);
        }

        // Format timestamp for display
        function formatTimestamp(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>